# 梁枠編集（パターン検出・切替）

本ドキュメントは v1.0 の 2D 描画（Konva.js）における「梁枠編集」の最小実装メモです。以下のスパン並びを検出し、発光（ハイライト）表示とクリック切替で柱マーカー・布材の表示を更新します。

- 1800,1800（間の1本のみ三角、3600mm 分の布材を点線）
- 1800,1800,1800（間の2本を三角、5400mm 分の布材を点線）
- 1800,900（間の1本を三角、2700mm 分の布材を点線）

重複パターン（例: 1800,1800,900 には 1800,1800 と 1800,900 が重なる）は、同一のハイライト領域をクリックするたびに連続して切り替わります。

## 実装ポイント

- スパン検出ロジック: `scaffai/frontend/lib/patterns.ts`
  - `detectMatches`: 上記 3 パターンをスライディングで抽出
  - `detectPatternGroups`: 重複マッチを 1 つのグループに統合（クリック領域単位）

- 描画と切替: `scaffai/frontend/components/BeamEditor.tsx`
  - グループ毎に半透明の矩形で発光表示、クリックで `selectedIndex` を循環
  - 選択中のマッチに含まれる「間の柱」を三角マーカーに変更
  - 選択中のマッチ範囲（開始柱〜終了柱）に点線の布材ラインを重ねて強調

## 動かし方（開発時）

フロントエンド:

```
cd scaffai/frontend
npm install
npm run dev
```

ブラウザで `http://localhost:3000` を開き、スパン欄を編集して動作を確認できます。

## テスト

```
cd scaffai/frontend
npm run test
```

`frontend/tests/patterns.test.ts` に検出とグルーピングの簡易テストを用意しています。

## 拡張メモ

- 許容誤差（±mm）を設けて近似一致でもパターン検出できるようにする
- クリックで「なし」状態も含めて循環（OFF → 1件目 → 2件目 → ...）にする設定
- UI ガイド（色・サイズ・アニメーション）を `docs/` に追記
- 生成AIとの接続（`shared/aiFunctions.ts`）や DXF 出力反映は別タスクで拡張

