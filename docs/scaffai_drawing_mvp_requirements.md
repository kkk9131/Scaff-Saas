# 🧱 Scaff 平面図作図機能 要件定義書（MVP版）

- 文書名: Scaff Drawing (Plan) MVP Requirements
- バージョン: v0.9（初稿）
- 更新日: 2025-10-26
- 対象: Phase 3「作図機能（平面図）」のMVP範囲
- 前提: 認証・案件管理・共通UIが利用可能であること（Phase 0〜2 完了）

---

## 1. 概要

本システムは、足場業向けSaaS「Scaff」における**平面図作図機能（MVP）**の要件を定義する。目的は、従来CADでは煩雑だった足場設計を、職人の感覚でスピーディに作図・編集・確認できるUIとして提供すること。

MVPの範囲は以下とする。
- 平面図ベースの自動割付作図（サックスモード）
- 部材編集（柱・布材・ブラケット・アンチ・階段・梁枠）
- メモ配置（注記）
- ビューモード（情報確認ホバーカード）
- データ保存（Supabase連携・JSON）＋PNG出力

---

## 2. 技術構成

- フロントエンド: React + Vite（Next.js相当の設計指針に準拠）
- 描画ライブラリ: Konva.js + React-Konva
- スタイル/UI: Tailwind CSS + shadcn/ui
- 状態管理: React Context / Zustand（軽量）
- データ保存: Supabase（JSON保存／認証／共有）
- 出力形式: JSON + PNG（`stage.toDataURL()` / `stage.toJSON()`）

---

## 3. 機能要件

### 3.1 モード構成（タブ式＋ショートカット）

| モード | 機能 | ショートカット |
|---|---|---|
| 🧩 作図モード | スパン自動生成（サックスモード） | `1` |
| ✏️ 編集モード | 柱・布材・ブラケット・アンチ・階段・梁枠の編集 | `2` |
| 🗒 メモモード | 注記・備考の配置 | `3` |
| 👁 ビューモード | 各部材の情報確認（ホバーカード） | `4` |

- モードはタブUI＋ショートカット双方で切替可能。
- モード状態はZustandで集中管理し、全UIで同期する。

### 3.2 作図モード（サックスモード）

- 概要: 線を引くだけで、布材・柱・ブラケット・アンチを自動生成する「パズル型作図」。
- 入力操作: ユーザーが始点クリック → 終点ドラッグ（例：3600mm）。
- 自動生成: スパン長に応じて構成部材を自動生成し、`ScaffoldGroup` としてグループ化。
  - 例（3600mm）:
    - 布材: 1800 × 2 本
    - 柱: 3 本（節点）
    - ブラケット: 3 本（方向ベクトルに応じ外向き）
    - アンチ: 2 枚（ブラケット間 400 × 1800）
- キー操作:
  - `Shift`: ブラケット種別切替（W=600 / S=355）
  - `Alt`: ブラケット＋アンチ方向の反転
- 配置方向ルール（描画方向 → 外向き方向）:
  - 左→右: 下
  - 上→下: 左
  - 右→左: 上
  - 下→上: 右
- スナップ設定:
  - グリッド単位: 150mm / 300mm（切替可）
  - スナップ: ON/OFF 切替
  - グリッド表示: 灰色ライン

### 3.3 編集モード

- 編集対象: 柱／布材／ブラケット／アンチ／階段／梁枠
- キャンバス内ポップアップ編集UI（丸角カード）
  - 対象クリックで表示、対象の右上付近にポップ。
  - `Esc` で閉じる、`Enter` で確定。
  - 操作は基本「即時反映」（適用ボタン不要）。
  - 複数選択編集（Shift+クリック or 投げ縄）に対応。

- 編集内容（セクション別）
  - 柱: 種別（A,C,D,E,G,DG,EG,C-47,KD）、数量、段数、ブラケット追加
  - 布材: 分割、数量変更、分割時のブラケット・柱追加
  - ブラケット: 数量、方向、寸法（600/355）編集、柱追加
  - アンチ: 数量、段数、タイプ（W/S）
  - 階段: スパン逆向き追加、数量・筋交編集、方向反転（Shift）
  - 梁枠: スパンパターン切替（例: 1800×3、1800×1800×900）、マーカー変換（⚪︎→△）

### 3.4 柱の高さ構造

- 高さ計算式: `totalHeight = (levels × 1900) + jack.height`
- 柱構造（TypeScriptモデル）:

```ts
/**
 * 柱（PillarPart）のモデル。
 * - levels: 段数（1段=1900mm）
 * - types: 柱種別の配列（例: ["D","C","A"]）
 * - jack: ジャッキ情報（高さmm／集計対象か）
 * - marker: 表示用マーカー（丸/三角/四角）
 */
export type PillarPart = {
  id: string;
  position: { x: number; y: number };
  levels: number;
  types: string[]; // 例: ["D","C","A"]
  jack: { height: number; counted: boolean };
  marker: "circle" | "triangle" | "square";
  totalHeight: number; // 派生計算
};
```

- ジャッキ管理（集計ルール）
  - ⚪︎: 通常柱 → 高さ＋300mm／数量カウント対象
  - △: 特殊柱（端・梁枠）→ 集計対象外
  - ◻︎: 補助柱 → 集計対象外
  - 備考: 平面図にはジャッキを描画しない（柱と重なるため）。ジャッキ数量＝丸マーカーの数。

### 3.5 メモモード

- 配置: 任意座標にクリックで配置。
- 内容: テキストメモ（例：「3段目から分割」）。
- 編集: クリックで直接編集可能。
- 保存: JSONに `meta.memo` として保存。
- 出力: PNG出力時に ON/OFF 切替可能。

### 3.6 ビューモード

- 概要: 閲覧専用モード（編集無効）。
- ホバー時、情報カードを表示。
- カード表示内容
  - 部材種別（柱／布材／ブラケット／アンチ／階段／梁枠）
  - 数量（集計または個別）
  - 段数（柱段数 or アンチ段数）
  - タイプ（例: A, C, D）
  - 長さ（mm）
- デザイン
  - 背景: 白＋透明度0.8
  - 角丸: `radius-2xl`
  - フォント: 小さめ（現場タブレットでも視認可能）
  - 表示位置: カーソル右上 10px 付近
  - 閉じ方: カーソルアウト時に自動フェードアウト

---

## 4. データ構造（MVP）

```ts
export type ScaffoldGroup = {
  id: string;
  parts: ScaffoldPart[];
};

export type ScaffoldPart = {
  id: string;
  type: "柱" | "布材" | "ブラケット" | "アンチ" | "階段" | "梁枠";
  position: { x: number; y: number };
  color: string; // white/red/blue/green
  marker?: "circle" | "triangle" | "square";
  meta?: any;
};
```

- 備考: 上記はMVPの最小モデル。将来拡張時は `shared/schemas/` にJSONスキーマを配備し、バージョン付与（例: `scaffold_v1.json`）。

---

## 5. 出力・保存

| 出力形式 | 内容 |
|---|---|
| JSON | Supabaseに保存（プロジェクト別）。`stage.toJSON()` をベースにメタ情報を同時保存。 |
| PNG | `stage.toDataURL()` で出力（メモの表示ON/OFF切替）。 |
| SVG | 非対応（Ver1.0以降）。 |
| PDF | 非対応（立面図実装後）。 |

- 自動保存: 10秒ごと、または操作後10アクション以内に差分保存。
- 将来: Supabase Realtimeでの共有・同期は後続フェーズで対応。

---

## 6. UIレイアウト

```
┌────────────────────────────────────────┐
│ ヘッダー（保存・出力・モード切替タブ） │
├─────────────┬────────────────────────────┬─────────────┤
│ 左サイドバー │        メインキャンバス（Konva Stage）        │ 右サイドバー │
│（モード選択） │  作図エリア：ズーム・パン対応                │（AIチャット） │
├────────────────────────────────────────┤
│ アンダーバー（座標・寸法・選択情報）                       │
└────────────────────────────────────────┘
```

- 左サイドバー: モード切替、スナップ、グリッド間隔、ブラケットW/S切替。
- 右サイドバー: 将来的なAIチャット（MVPでは占位のみ）。
- アンダーバー: マウス座標／現在スパン寸法／選択数／集計（例: 柱=12, ジャッキ=10）。

---

## 7. 非機能要件

- 操作レスポンス: 描画・編集操作は 0.2 秒以内。
- 表示対応: PC・タブレット（iPad 13インチ推奨）。
- 自動保存: 10秒ごと or 操作後10アクション以内。
- 将来の同期: Supabase API経由でリアルタイム反映（将来的）。

---

## 8. 将来拡張（Ver1.0〜）

- 立面図生成（東西南北テンプレート）
- PDF出力・見積書テンプレート連携
- 3D自動生成（AI連携）
- DXF出力（別タスクとして段階導入）

---

## 9. MVP完成定義（Done条件）

| 区分 | 完了条件 |
|---|---|
| 作図モード | スパン自動生成＋ブラケット方向反転・切替が可能 |
| 編集モード | 各部材ごとの数量・種別・分割・追加が可能 |
| メモモード | テキスト配置・編集・削除が可能 |
| ビューモード | 各部材ホバーで情報ポップアップ表示 |
| 保存・出力 | JSON保存（Supabase）＋PNG出力が動作 |
| UI | 左サイドバー・アンダーバー・ショートカット動作確認 |

---

## 10. タスクトレーサビリティ（Phase 3への写像）

- 本要件は `docs/scaffai_task_tickets.md` の Phase 3（TASK-301〜TASK-312）に対応付け済み。
- 各タスクの「完了条件」が本章のDone条件を満たすよう設計されている。

